
<!DOCTYPE html>
<html lang="bg">
<head>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>–ù–æ–Ω –°—Ç–æ–ø –û—Ç—á–µ—Ç</title>
  <style>

label[for="amount"], label[for="note"] {
  display: block;
  margin-top: 10px;
}
input#amount, input#note {
  max-width: 300px;
  display: block;
  margin-bottom: 10px;
}


input[type="password"], input[type="number"], input[type="text"], input[type="date"], select {
  padding: 8px;
  font-size: 14px;
  border-radius: 4px;
}
input#password {
  max-width: 200px;
  margin: 0 auto;
  display: block;
}
input#note, input#amount, input#searchNote, input#filterNote {
  max-width: 300px;
}


@media (max-width: 600px) {
  body {
    padding: 10px;
    font-size: 14px;
  }
  input, select, button {
    font-size: 14px;
  }
  table, th, td {
    font-size: 13px;
    word-break: break-word;
  }
  canvas {
    max-width: 100% !important;
    height: auto !important;
  }
  .btn-group {
    flex-direction: column;
    gap: 6px;
  }
}

    body { font-family: Arial; background: #121212; color: #fff; padding: 20px; max-width: 700px; margin: auto; }
    input, select, button { padding: 10px; margin: 5px 0; width: 100%; font-size: 16px; border: none; border-radius: 5px; }
    button { cursor: pointer; background: #2196f3; color: white; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid #333; }
    .hidden { display: none; }
    .summary { background: #1e1e1e; padding: 10px; margin-top: 10px; border-radius: 5px; }
    .btn-group { display: flex; gap: 10px; }
  </style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div id="login">
  <h2>üîê –í—ä–≤–µ–¥–∏ –ø–∞—Ä–æ–ª–∞</h2>
  <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª–∞">
  <button onclick="checkPassword()" style="max-width: 200px; margin: 10px auto; display: block;">–í—Ö–æ–¥</button>
</div>


<div id="app" class="hidden">
<div id="screen-add">

  <h2>üìã –ù–æ–Ω –°—Ç–æ–ø –û—Ç—á–µ—Ç</h2>

  <label>–î–∞—Ç–∞</label><input type="date" id="date" />
  <label>–¢–∏–ø</label><select id="type"><option>–ü—Ä–∏—Ö–æ–¥</option><option>–†–∞–∑—Ö–æ–¥</option></select>
  <label>–ú–µ—Ç–æ–¥</label><select id="method"><option>–ö–µ—à</option><option>–ë–∞–Ω–∫–∞</option></select>
  <label>–°—É–º–∞</label><input type="number" id="amount" />
  <label>–ë–µ–ª–µ–∂–∫–∞</label><input type="text" id="note" />

  <div class="btn-group">
    <button onclick="addRecord()">–î–æ–±–∞–≤–∏ –∑–∞–ø–∏—Å</button>
    <button id="editBtn" onclick="saveEditedRecord()" style="display:none; background:#4caf50;">üíæ –ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ</button>
  </div>
  <div class="btn-group">
    <button onclick="showScreen('report')">üìä –û—Ç—á–µ—Ç–∏</button>
    <button onclick="window.print()">üñ®Ô∏è –ü—Ä–∏–Ω—Ç–∏—Ä–∞–π</button>
  </div>

  <div class="summary" id="totalSummary"></div>

  </div>
<div id="screen-report" class="hidden">
<h3>üìä –û—Ç—á–µ—Ç–∏</h3>


<div style="margin-top:20px;">
  <label>üîç –¢—ä—Ä—Å–∏ –ø–æ –±–µ–ª–µ–∂–∫–∞:</label>
  <input type="text" id="filterNote" oninput="renderFilteredTable()">
  <label>üìÜ –û—Ç –¥–∞—Ç–∞:</label>
  <input type="date" id="filterFrom" onchange="renderFilteredTable()">
  <label>–î–æ –¥–∞—Ç–∞:</label>
  <input type="date" id="filterTo" onchange="renderFilteredTable()">
  <label>–¢–∏–ø:</label>
  <select id="filterType" onchange="renderFilteredTable()">
    <option value="">–í—Å–∏—á–∫–∏</option>
    <option value="–ü—Ä–∏—Ö–æ–¥">–ü—Ä–∏—Ö–æ–¥</option>
    <option value="–†–∞–∑—Ö–æ–¥">–†–∞–∑—Ö–æ–¥</option>
  </select>
  <label>–ú–µ—Ç–æ–¥:</label>
  <select id="filterMethod" onchange="renderFilteredTable()">
    <option value="">–í—Å–∏—á–∫–∏</option>
    <option value="–ö–µ—à">–ö–µ—à</option>
    <option value="–ë–∞–Ω–∫–∞">–ë–∞–Ω–∫–∞</option>
  </select>
</div>
<div class="summary" id="dailySummary"></div>
<div class="summary" id="monthlySummary"></div>
<canvas id="chart" width="400" height="200" style="margin-top:20px;"></canvas>

<button onclick="showScreen('add')">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
</div>
<div id="screen-add">
<table id="recordsTable">
    <thead>
      <tr><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–°—É–º–∞</th><th>–ú–µ—Ç–æ–¥</th><th>–ë–µ–ª–µ–∂–∫–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="btn-group" style="margin-top: 20px;">
    <button onclick="exportToExcel()">üì§ Excel</button>
    <button onclick="exportToExcel()">üì§ Excel</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let records = [];
let editIndex = -1;

function checkPassword() {
  const pass = document.getElementById("password").value;
  if (pass === "7801") {
    document.getElementById("login").style.display = "none";
    document.getElementById("app").classList.remove("hidden");
    loadFromLocal();
    renderTable();
  updateSummaries();
  renderChart();
  } else {
    alert("–ì—Ä–µ—à–Ω–∞ –ø–∞—Ä–æ–ª–∞!");
  }
}

function addRecord() {
  const date = dateEl().value;
  const type = typeEl().value;
  const method = methodEl().value;
  const amount = parseFloat(amountEl().value);
  const note = noteEl().value;
  if (!date || isNaN(amount)) return alert("–ü–æ–ø—ä–ª–Ω–∏ –¥–∞—Ç–∞ –∏ —Å—É–º–∞.");
  records.push({ date, type, method, amount, note });
  saveToLocal();
  clearForm();
  renderTable();
  updateSummaries();
  renderChart();
}

function editRecord(i) {
  const r = records[i];
  dateEl().value = r.date;
  typeEl().value = r.type;
  methodEl().value = r.method;
  amountEl().value = r.amount;
  noteEl().value = r.note;
  editIndex = i;
  document.getElementById("editBtn").style.display = "block";
}

function saveEditedRecord() {
  if (editIndex === -1) return;
  const date = dateEl().value;
  const type = typeEl().value;
  const method = methodEl().value;
  const amount = parseFloat(amountEl().value);
  const note = noteEl().value;
  if (!date || isNaN(amount)) return alert("–ü–æ–ø—ä–ª–Ω–∏ –¥–∞—Ç–∞ –∏ —Å—É–º–∞.");
  records[editIndex] = { date, type, method, amount, note };
  saveToLocal();
  editIndex = -1;
  clearForm();
  document.getElementById("editBtn").style.display = "none";
  renderTable();
  updateSummaries();
  renderChart();
}

function deleteRecord(i) {
  if (!confirm("–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏?")) return;
  records.splice(i, 1);
  saveToLocal();
  renderTable();
  updateSummaries();
  renderChart();
}

function renderTable() {
  const tbody = document.querySelector("#recordsTable tbody");
  tbody.innerHTML = "";
  let income = 0, expense = 0;
  records.forEach((r, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.date}</td>
      <td>${r.type}</td>
      <td>${r.amount.toFixed(2)} –ª–≤</td>
      <td>${r.method}</td>
      <td>${r.note}</td>
      <td>
        <button onclick="editRecord(${i})" style="font-size: 12px; padding: 4px 6px;">‚úèÔ∏è</button>
        <button onclick="deleteRecord(${i})" style="background:#f44336; margin-left:5px; font-size: 12px; padding: 4px 6px;">üóëÔ∏è</button>
      </td>`;
    tbody.appendChild(tr);
    if (r.type === "–ü—Ä–∏—Ö–æ–¥") income += r.amount;
    if (r.type === "–†–∞–∑—Ö–æ–¥") expense += r.amount;
  });
  const balance = income - expense;
  document.getElementById("totalSummary").innerHTML = `
    –ü—Ä–∏—Ö–æ–¥–∏: ${income.toFixed(2)} –ª–≤ |
    –†–∞–∑—Ö–æ–¥–∏: ${expense.toFixed(2)} –ª–≤ |
    –ë–∞–ª–∞–Ω—Å: ${balance.toFixed(2)} –ª–≤`;
}

function clearForm() {
  dateEl().value = "";
  amountEl().value = "";
  noteEl().value = "";
}

function saveToLocal() {
  localStorage.setItem("nonstop_records", JSON.stringify(records));
}
function loadFromLocal() {
  const saved = localStorage.getItem("nonstop_records");
  if (saved) records = JSON.parse(saved);
}

function dateEl() { return document.getElementById("date"); }
function typeEl() { return document.getElementById("type"); }
function methodEl() { return document.getElementById("method"); }
function amountEl() { return document.getElementById("amount"); }
function noteEl() { return document.getElementById("note"); }

function exportToExcel() {
  const wb = XLSX.utils.book_new();
  const rows = [["–î–∞—Ç–∞", "–¢–∏–ø", "–°—É–º–∞", "–ú–µ—Ç–æ–¥", "–ë–µ–ª–µ–∂–∫–∞"]];
  records.forEach(r => rows.push([r.date, r.type, r.amount.toFixed(2), r.method, r.note]));
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "–û—Ç—á–µ—Ç");
  XLSX.writeFile(wb, "nonstop_otchet.xlsx");
}


function showScreen(name) {
  document.getElementById("screen-add").classList.add("hidden");
  document.getElementById("screen-report").classList.add("hidden");
  document.getElementById("screen-" + name).classList.remove("hidden");
}


function updateSummaries() {
  let todayIncome = 0, todayExpense = 0;
  let monthIncome = 0, monthExpense = 0;
  const today = new Date().toISOString().slice(0, 10);
  const month = today.slice(0, 7);
  records.forEach(r => {
    if (r.date === today) {
      if (r.type === "–ü—Ä–∏—Ö–æ–¥") todayIncome += r.amount;
      if (r.type === "–†–∞–∑—Ö–æ–¥") todayExpense += r.amount;
    }
    if (r.date.startsWith(month)) {
      if (r.type === "–ü—Ä–∏—Ö–æ–¥") monthIncome += r.amount;
      if (r.type === "–†–∞–∑—Ö–æ–¥") monthExpense += r.amount;
    }
  });

  document.getElementById("dailySummary").innerHTML = `
    üìÖ <strong>–î–Ω–µ—Å:</strong> –ü—Ä–∏—Ö–æ–¥–∏: ${todayIncome.toFixed(2)} –ª–≤ | –†–∞–∑—Ö–æ–¥–∏: ${todayExpense.toFixed(2)} –ª–≤`;
  document.getElementById("monthlySummary").innerHTML = `
    üìÜ <strong>–ú–µ—Å–µ—Ü:</strong> –ü—Ä–∏—Ö–æ–¥–∏: ${monthIncome.toFixed(2)} –ª–≤ | –†–∞–∑—Ö–æ–¥–∏: ${monthExpense.toFixed(2)} –ª–≤`;
}


function renderFilteredTable() {
  const noteVal = document.getElementById("filterNote").value.toLowerCase();
  const from = document.getElementById("filterFrom").value;
  const to = document.getElementById("filterTo").value;
  const type = document.getElementById("filterType").value;
  const method = document.getElementById("filterMethod").value;

  const tbody = document.querySelector("#recordsTable tbody");
  tbody.innerHTML = "";
  let income = 0, expense = 0;

  records.forEach((r, i) => {
    const matchNote = r.note.toLowerCase().includes(noteVal);
    const matchDate = (!from || r.date >= from) && (!to || r.date <= to);
    const matchType = !type || r.type === type;
    const matchMethod = !method || r.method === method;

    if (matchNote && matchDate && matchType && matchMethod) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.date}</td>
        <td>${r.type}</td>
        <td>${r.amount.toFixed(2)} –ª–≤</td>
        <td>${r.method}</td>
        <td>${r.note}</td>
        <td>
          <button onclick="editRecord(${i})" style="font-size: 12px; padding: 4px 6px;">‚úèÔ∏è</button>
          <button onclick="deleteRecord(${i})" style="background:#f44336; margin-left:5px; font-size: 12px; padding: 4px 6px;">üóëÔ∏è</button>
        </td>`;
      tbody.appendChild(tr);
      if (r.type === "–ü—Ä–∏—Ö–æ–¥") income += r.amount;
      if (r.type === "–†–∞–∑—Ö–æ–¥") expense += r.amount;
    }
  });

  const balance = income - expense;
  document.getElementById("totalSummary").innerHTML = `
    <strong>–§–∏–ª—Ç—Ä–∏—Ä–∞–Ω–æ:</strong> –ü—Ä–∏—Ö–æ–¥–∏: ${income.toFixed(2)} –ª–≤ |
    –†–∞–∑—Ö–æ–¥–∏: ${expense.toFixed(2)} –ª–≤ |
    –ë–∞–ª–∞–Ω—Å: ${balance.toFixed(2)} –ª–≤`;
}


function exportFilteredToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("–§–∏–ª—Ç—Ä–∏—Ä–∞–Ω –æ—Ç—á–µ—Ç", 14, 14);
  let y = 24;

  const noteVal = document.getElementById("filterNote").value.toLowerCase();
  const from = document.getElementById("filterFrom").value;
  const to = document.getElementById("filterTo").value;
  const type = document.getElementById("filterType").value;
  const method = document.getElementById("filterMethod").value;

  records.forEach(r => {
    const matchNote = r.note.toLowerCase().includes(noteVal);
    const matchDate = (!from || r.date >= from) && (!to || r.date <= to);
    const matchType = !type || r.type === type;
    const matchMethod = !method || r.method === method;
    if (matchNote && matchDate && matchType && matchMethod) {
      doc.text(`${r.date} | ${r.type} | ${r.amount.toFixed(2)} –ª–≤ | ${r.method} | ${r.note}`, 14, y);
      y += 8;
      if (y > 280) {
        doc.addPage();
        y = 20;
      }
    }
  });

  doc.save("filtered_otchet.pdf");
}

function exportFilteredToExcel() {
  const wb = XLSX.utils.book_new();
  const rows = [["–î–∞—Ç–∞", "–¢–∏–ø", "–°—É–º–∞", "–ú–µ—Ç–æ–¥", "–ë–µ–ª–µ–∂–∫–∞"]];

  const noteVal = document.getElementById("filterNote").value.toLowerCase();
  const from = document.getElementById("filterFrom").value;
  const to = document.getElementById("filterTo").value;
  const type = document.getElementById("filterType").value;
  const method = document.getElementById("filterMethod").value;

  records.forEach(r => {
    const matchNote = r.note.toLowerCase().includes(noteVal);
    const matchDate = (!from || r.date >= from) && (!to || r.date <= to);
    const matchType = !type || r.type === type;
    const matchMethod = !method || r.method === method;
    if (matchNote && matchDate && matchType && matchMethod) {
      rows.push([r.date, r.type, r.amount.toFixed(2), r.method, r.note]);
    }
  });

  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "–§–∏–ª—Ç—Ä–∏—Ä–∞–Ω–∏");
  XLSX.writeFile(wb, "filtered_otchet.xlsx");
}


let chartRef = null;

function renderChart() {
  const ctx = document.getElementById('chart').getContext('2d');
  const monthData = {};

  records.forEach(r => {
    const month = r.date?.slice(0, 7);
    if (!month) return;
    if (!monthData[month]) monthData[month] = { income: 0, expense: 0 };
    if (r.type === "–ü—Ä–∏—Ö–æ–¥") monthData[month].income += r.amount;
    if (r.type === "–†–∞–∑—Ö–æ–¥") monthData[month].expense += r.amount;
  });

  const labels = Object.keys(monthData).sort();
  const incomeData = labels.map(m => monthData[m].income);
  const expenseData = labels.map(m => monthData[m].expense);

  if (chartRef) chartRef.destroy(); // –ø—Ä–µ–∑–∞—Ä–µ–∂–¥–∞–Ω–µ
  chartRef = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        { label: '–ü—Ä–∏—Ö–æ–¥–∏', data: incomeData, backgroundColor: '#4caf50' },
        { label: '–†–∞–∑—Ö–æ–¥–∏', data: expenseData, backgroundColor: '#f44336' }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        title: { display: true, text: '–ü—Ä–∏—Ö–æ–¥–∏ –∏ —Ä–∞–∑—Ö–æ–¥–∏ –ø–æ –º–µ—Å–µ—Ü–∏' }
      }
    }
  });
}

function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("–ù–æ–Ω –°—Ç–æ–ø –û—Ç—á–µ—Ç", 14, 14);
  let y = 24;
  records.forEach(r => {
    doc.text(`${r.date} | ${r.type} | ${r.amount.toFixed(2)} –ª–≤ | ${r.method} | ${r.note}`, 14, y);
    y += 8;
    if (y > 280) {
      doc.addPage();
      y = 20;
    }
  });
  doc.save("nonstop_otchet.pdf");
}
</script>
</body>
</html>
